import{m as D}from"./include.dom-fa565471.js";const e={currentInstanceId:0,instanceLabels:["default"],instanceDBs:[],config:{},liveDom:{base:D.base(),instancePanel:D.instancePanel(),addAppSeting:D.addAppSetings(),addInstance:D.addInstance(),addBookmark:D.addBookmarkSeelector(),addRssFeed:D.addRssFeedSeelector(),addText:D.addTextSelector(),addTagBlock:D.addTagBlock(),tagTreePanel:{},contentsPanel:{base:D.contentsPanel.base()}},init:async function(){const l=await window.electron.ipcRenderer.invoke("get-config");this.config=l,this.instanceDBs=l.instance,this.currentInstanceId=l.cache.currentInstanceId,this.windowControl(),this.AppSetingPanel(),this.instancePanelControl.addInstance(),this.instancePanelControl.addBookmark(),this.instancePanelControl.addRssFeed(),this.instancePanelControl.addText(),this.instancePanelControl.addTagBlock(),this.instancePanelControl.tagTreePanel(),this.instancePanelControl.addContents(),window.addEventListener("keydown",o=>{o.ctrlKey&&o.shiftKey&&o.code==="KeyA"?window.electron.ipcRenderer.send("window-hide","test"):o.ctrlKey&&o.shiftKey&&o.code==="KeyD"?window.electron.ipcRenderer.invoke("get-rss-feed","https://forest.watch.impress.co.jp/").then(g=>{console.log(g)}):o.ctrlKey&&o.altKey&&o.code==="KeyD"&&window.electron.ipcRenderer.send("open-dev-tool")})},windowControl:function(){this.liveDom.base.querySelector("div#close-win > button")?.addEventListener("click",()=>{window.electron.ipcRenderer.send("window-close")}),this.liveDom.base.querySelector("div#maximize-win button")?.addEventListener("click",()=>{window.electron.ipcRenderer.send("window-maximize","main")}),this.liveDom.base.querySelector("div#minimize-win button")?.addEventListener("click",()=>{window.electron.ipcRenderer.send("window-minize","main")}),this.liveDom.base.querySelector("div#hide-win button")?.addEventListener("click",()=>{window.electron.ipcRenderer.send("window-hide","main")}),this.liveDom.instancePanel.querySelector("button#open-clip-manage-btn").addEventListener("click",()=>{window.electron.ipcRenderer.send("clipboard-win-open")}),this.liveDom.instancePanel.querySelector("button#open-feed-reader-btn").addEventListener("click",()=>{window.electron.ipcRenderer.send("feedreader-win-open")}),this.liveDom.base.querySelector("main#insert-panel")?.append(this.liveDom.instancePanel),document.getElementById("app")?.append(this.liveDom.base),window.electron.ipcRenderer.on("config-update",(l,o)=>{this.instanceDBs=o.instance,this.config=o})},AppSetingPanel:function(){this.instancePanelControl.commonModalWindow("#app-setings",this.liveDom.addAppSeting,".app-setings-modal-wrap","div.app-seting-element"),this.liveDom.addAppSeting.querySelector("#import-bookmark").addEventListener("change",l=>{const o=new FileReader,g=l.target.files;if(g?.length===1){const u=g[0];u.type==="text/html"&&(o.readAsText(u,"UTF-8"),o.onerror=()=>{alert("ファイルの読み込みに失敗しました。")},o.onload=()=>{e.shareParts.toggleLoadingEfect(!0),window.electron.ipcRenderer.invoke("import-bookmark-file",{instanceId:e.currentInstanceId,html:o.result}).then(async p=>{e.shareParts.toggleLoadingEfect(!1),Array.isArray(p)&&(await window.electron.ipcRenderer.invoke("set-tag-tree-cache",null),window.electron.ipcRenderer.send("window-reload"))})})}}),e.liveDom.instancePanel.insertAdjacentElement("afterend",this.liveDom.addAppSeting)},instancePanelControl:{addInstance:function(){this.commonModalWindow("#show-inscetance-modal-btn",e.liveDom.addInstance,".instance-select-element-wrap","div.instance-names");let l,o={};const g=(u,p)=>{const b=document.createElement("span");b.classList.add("label-wrap");const f=document.createElement("button");f.classList.add("delete"),f.title="インスタンス削除",f.ariaLabel="インスタンス削除",f.dataset.id=p,f.dataset.name=u,f.innerHTML='<i class="fa-solid fa-xmark">',f.addEventListener("click",()=>{if(Object.keys(o).length===1){alert("インスタンスが1つの場合は削除できません。");return}if(confirm("インスタンスを削除してもよろしいですか？")){b.remove(),delete o[f.dataset.id],e.liveDom.tagTreePanel[f.dataset.id].remove(),delete e.liveDom.tagTreePanel[f.dataset.id],e.instanceDBs.forEach((k,y)=>{if(k.id===Number(f.dataset.id)){e.instanceDBs.splice(y,1);return}});const v=Object.values(o).shift();v.dispatchEvent(new Event("click")),e.liveDom.instancePanel.querySelector("div.tag-select-panel").dispatchEvent(new Event("click")),l=v,window.electron.ipcRenderer.send("remove-instance",Number(f.dataset.id))}});const c=document.createElement("input");return c.type="text",c.value=u,c.dataset.id=p,c.addEventListener("change",v=>{window.electron.ipcRenderer.send("ite-name-update",{name:v.target.value,id:Number(p)})}),c.addEventListener("click",v=>{l.style.removeProperty("border-bottom-color"),l.style.removeProperty("background-color"),v.target.style.borderBottomColor="lightgreen",v.target.style.backgroundColor="#294c29";const k=e.currentInstanceId;e.currentInstanceId=Number(v.target.dataset.id),e.config.cache.currentInstanceId=Number(v.target.dataset.id),window.dispatchEvent(new CustomEvent("ite_change",{detail:{id:k}})),window.electron.ipcRenderer.send("set-ite-id-cache",Number(v.target.dataset.id)),l=v.target}),p===`${e.currentInstanceId}`&&(l=c,l.style.borderBottomColor="lightgreen",l.style.backgroundColor="#294c29"),b.appendChild(c),b.appendChild(f),o[p]=c,e.liveDom.addInstance.querySelector("span.label-group")?.appendChild(b),c};e.instanceDBs.forEach(u=>{g(u.label,`${u.id}`)}),e.liveDom.addInstance.querySelector("#add-instance-btn")?.addEventListener("click",()=>{window.electron.ipcRenderer.invoke("add-instance").then(u=>{g(u.label,`${u.id}`).click()})}),e.liveDom.instancePanel.insertAdjacentElement("afterend",e.liveDom.addInstance)},addBookmark:function(){this.commonModalWindow("#show-bookmark-modal-btn",e.liveDom.addBookmark,".add-bookmark-modal-wrap","#add-bookmark-url");const l=e.liveDom.addBookmark.querySelector("#add-bookmark-url"),o=e.liveDom.addBookmark.querySelector("#add-bookmark-title"),g=e.liveDom.addBookmark.querySelector("#add-bookmark-description"),u=e.liveDom.addBookmark.querySelector("#add-bookmark-memo"),p=e.liveDom.addBookmark.querySelector("#add-bookmark-screenshot"),b=e.liveDom.addBookmark.querySelector("#add-bookmark-general-thunb"),f=e.liveDom.addBookmark.querySelector("#add-bk-custom-thumb"),c=e.liveDom.addBookmark.querySelector("div.view-thumb"),v=c.innerHTML,k=e.liveDom.addBookmark.querySelector("#add-bookmark-btn");let y=null,E=null;l.addEventListener("change",a=>{const n=a.target.value;R("url",n)&&window.electron.ipcRenderer.invoke("get-site-metadata",n).then(s=>{s!==null&&(o.value=s.title,g.textContent=s.description.replace(/ |　/g,""),E=null,s.image?(T(s.image),E=s.image):t())})}),b.addEventListener("click",()=>{T(E)}),p.addEventListener("click",()=>{R("url",l.value)&&(p.disabled=!0,t(p))}),f.addEventListener("change",async a=>{const n=a.target.files;if(n&&n.length==1&&n[0].type.indexOf("image/")>-1){const s=await n[0].arrayBuffer(),r=await window.electron.ipcRenderer.invoke("get-mimeType-fromBuffer",s);if(r){const m=document.createElement("img");m.alt="サムネイル画像のプレビュー",c.innerHTML="",m.src=window.URL.createObjectURL(new Blob([s],{type:r.mime})),y={data:s,mimeType:r.mime},c.append(m)}}}),k.addEventListener("click",()=>{if(!R("url",l.value)||o.value=="")return;const a=e.liveDom.addBookmark.querySelector("span.selected-label");a.childElementCount!==0&&window.electron.ipcRenderer.invoke("register-bookmark",{instanceId:e.currentInstanceId,bookmark:{url:l.value,title:o.value,description:g.value,data:null,memo:u.value!=""?u.value:null,thunb:y?.data?y.data:null,thunb_mime:y?.mimeType?y.mimeType:null},tags:[...a.childNodes].map(n=>Number(n.dataset.id))}).then(n=>{n&&(l.value="",o.value="",g.value="",c.innerHTML=v,u.value="",a.innerHTML="",E=null,y=null,e.liveDom.addBookmark.querySelector("button.modal-close")?.click())})});function T(a){const n=document.createElement("img");n.alt="サムネイル画像のプレビュー",c.innerHTML="",a?window.electron.ipcRenderer.invoke("get-webpage-image",a).then(s=>{s?(n.src=window.URL.createObjectURL(new Blob([s.data],{type:s.mimeType})),y=s,c.append(n)):c.innerHTML=v}):c.innerHTML=v}function t(a){window.electron.ipcRenderer.invoke("get-dom-screenshot",l.value).then(n=>{const s=document.createElement("img");s.src=window.URL.createObjectURL(new Blob([n],{type:"image/png"})),s.alt="サムネイル画像のプレビュー",c.innerHTML="",c.append(s),y={data:n,mimeType:"image/png"},a&&(a.disabled=!1)})}e.liveDom.instancePanel.insertAdjacentElement("afterend",e.liveDom.addBookmark)},addRssFeed:function(){this.commonModalWindow("#show-rss-feed-modal-btn",e.liveDom.addRssFeed,".add-rss-feed-modal-wrap","#add-rss-feed-url"),e.liveDom.instancePanel.insertAdjacentElement("afterend",e.liveDom.addRssFeed)},addText:function(){e.liveDom.instancePanel.querySelector("#show-text-modal-btn").addEventListener("click",()=>{window.electron.ipcRenderer.send("notepad-open")})},addTagBlock:function(){[{liveDom:e.liveDom.addBookmark,inputId:"add-bookmark-tags"},{liveDom:e.liveDom.addRssFeed,inputId:"add-rss-tags"},{liveDom:e.liveDom.contentsPanel.base,inputId:"bk-dts-tags"}].forEach(l=>{l.liveDom.querySelector("div.form.tags")?.insertAdjacentElement("beforeend",D.addTagBlock(l.inputId));const o=l.liveDom.querySelector("span.tag_suggest"),g=l.liveDom.querySelector("span.selected-label"),u={isFirst:!0,doms:[],selected:{id:null,name:null}};let p=0;const b=(c,v,k,y=!1)=>{if(g?.querySelector(`span.label[data-id="${c}"]`))return;const E=document.createElement("span");E.classList.add("label"),E.textContent=v,E.dataset.id=c,E.dataset.name=v;const T=document.createElement("button");T.innerHTML='<i class="fa-solid fa-xmark"></i>',T.ariaLabel="削除",T.addEventListener("click",()=>{E.remove()}),E.appendChild(T),y&&(T.hidden=!0),k&&(k.target.value="",setTimeout(()=>{k.target.focus()},300)),g?.append(E)};g.addEventListener("tag-insert",c=>{g.innerHTML="",c.detail.forEach(v=>{b(`${v.id}`,v.name,void 0,!0)})});let f=!1;l.liveDom.querySelector("input.tag_input")?.addEventListener("keydown",c=>{c.code==="Tab"&&f==!0&&c.preventDefault()}),l.liveDom.querySelector("input.tag_input")?.addEventListener("keyup",c=>{c.isComposing||(c.code==="ArrowDown"||c.code==="ArrowUp"?u.isFirst===!0&&c.code==="ArrowDown"?(u.doms[p].style.backgroundColor="#555555",u.isFirst=!1):u.isFirst===!0&&c.code==="ArrowUp"?(u.doms[p=u.doms.length-1].style.backgroundColor="#555555",u.isFirst=!1):u.isFirst===!1&&c.code==="ArrowDown"?(u.doms[p].style.removeProperty("background-color"),u.doms[u.doms.length-1>p++?p:p=0].style.backgroundColor="#555555"):u.isFirst===!1&&c.code==="ArrowUp"&&(u.doms[p].style.removeProperty("background-color"),u.doms[u.doms.length>p&&p>0?p-=1:p=u.doms.length-1].style.backgroundColor="#555555"):c.code==="Tab"?(f===!0&&b(u.doms[p].dataset.id,u.doms[p].dataset.name,c),o.innerHTML="",o.style.opacity="0",o.inert=!0,f=!1):c.code==="Backspace"&&c.target.value==""?g.childElementCount>0&&[...g.childNodes].slice(-1)[0].remove():c.target.value!=""?(o.innerHTML="",f=!0,o.inert=!1,o.style.opacity="1",window.electron.ipcRenderer.invoke("get-add-tag-list",{id:e.currentInstanceId,keyword:c.target.value}).then(v=>{u.isFirst=!0,u.doms=[],p=0,v.forEach(k=>{const y=document.createElement("button");y.textContent=k.name,y.dataset.name=k.name,y.dataset.id=k.id,y.tabIndex=-1,y.addEventListener("click",()=>{b(k.id,k.name,c),o.innerHTML="",o.style.opacity="0",o.inert=!0}),u.doms.push(y),o.append(y)})})):c.target.value==""?(o.style.opacity="0",f=!1,o.inert=!0,o.innerHTML=""):(o.style.opacity="1",o.inert=!1,f=!0))})})},commonModalWindow:function(l,o,g,u=null){e.liveDom.base.querySelector(l).addEventListener("click",()=>{o.inert=!1,e.liveDom.instancePanel.inert=!0,o.querySelector(g)?.classList.add("show"),setTimeout(()=>{o.querySelector(u===null?l:u)?.focus()},600)}),o.querySelector(g)?.addEventListener("click",()=>{b()}),o.addEventListener("keydown",f=>{f.key==="Escape"&&b()});const p=o.querySelector("button.modal-close");p!==null&&p.addEventListener("click",()=>{b()});function b(){o.inert=!0,e.liveDom.instancePanel.inert=!1,o.querySelector(g)?.classList.remove("show"),e.liveDom.instancePanel.querySelector(l)?.focus()}},tagTreePanel:async function(){let l=null;const o=(t,a=!1)=>{if(t.expansionButtonList[0].dataset.tagId==="none")return;t.expansionButtonList.forEach((r,m)=>{const i=r.parentNode?.parentNode;r.addEventListener("click",async()=>{(r.dataset.loaded==="false"||a===!1)&&(r.dataset.loaded="true",await b(i,e.currentInstanceId,Number(r.dataset.tagId)));const d=i.querySelector("ul.tag-tree");r.dataset.opend==="false"?(d.classList.add("show"),d.style.height=`${d.scrollHeight}px`,setTimeout(()=>{d.style.height="auto"},250),d.inert=!1,r.dataset.opend="true",r.innerHTML='<i class="fa-solid fa-chevron-right"></i>'):(d.classList.remove("show"),d.style.height=`${d.scrollHeight}px`,setTimeout(()=>{d.style.height="0"},5),d.inert=!0,r.dataset.opend="false",r.innerHTML='<i class="fa-solid fa-chevron-down"></i>')}),i.addEventListener("mouseover",d=>{d.stopPropagation(),t.tagMenuButtonList[m].hidden=!1}),i.addEventListener("mouseout",d=>{d.stopPropagation(),t.tagMenuButtonList[m].hidden=!0})}),t.tagNameButtonList.forEach(r=>{r.addEventListener("click",()=>{e.shareParts.toggleLoadingEfect(!0),l&&l[e.currentInstanceId]?l[e.currentInstanceId].style.removeProperty("background-color"):l===null&&(l={});const m=r.parentNode;m.style.backgroundColor="#414141",l[e.currentInstanceId]=m;let i=[],d=1,w=r;for(;d>0;)w.tagName==="LI"&&d>0&&w.dataset.parentTagId!==void 0&&(d=Number(w.dataset.parentTagId),d>0&&i.push(d)),w=w.parentNode;i.push(Number(r.dataset.tagId)),window.electron.ipcRenderer.invoke("get-bookmarks",{instanceId:e.currentInstanceId,tagIdChain:i}).then(e.shareParts.getBookmarkItemDom)})});const n=e.liveDom.base.querySelector("div#show-tag-context-menu-wrap"),s=e.liveDom.base.querySelector("div#show-tag-context-menu");t.tagMenuButtonList.forEach((r,m)=>{r.addEventListener("click",()=>{const i=document.createElement("ul");i.classList.add("tag-menu-element"),[{class:"name-change",name:"名前を変更"},{class:"delete-tag",name:"削除"},{class:"add-new-tag",name:"新規タグ追加"}].forEach(w=>{const h=document.createElement("li");h.classList.add(w.class,"tag-menu"),h.textContent=w.name,h.dataset.tagId=r.dataset.tagId,h.tabIndex=0,h.role="button";const L=t.tagNameButtonList[m].parentNode?.parentNode;let I=L.querySelector("ul.tag-tree");switch(w.class){case"add-new-tag":h.addEventListener("click",async()=>{I===null&&(await b(L,e.currentInstanceId,Number(r.dataset.tagId)),I=L.querySelector("ul.tag-tree.sub")),t.expansionButtonList[m].dataset.loaded="true",t.expansionButtonList[m].dataset.opend==="false"&&(t.expansionButtonList[m].dataset.opend="true",I.classList.add("show"),I.style.height=`${I.scrollHeight}px`,setTimeout(()=>{I.style.height="auto"},250),I.inert=!1),v(I,Number(r.dataset.tagId)),n.hidden=!0,s.hidden=!0});break;case"name-change":h.addEventListener("click",()=>{v(I,Number(r.dataset.tagId),!0,L),n.hidden=!0,s.hidden=!0});break}i.append(h)}),s.innerHTML="",s.append(i);const d=r.getBoundingClientRect();s.style.top=`${d.top}px`,s.style.left=`${d.left+d.width}px`,n.hidden=!1,s.hidden=!1})}),n.addEventListener("click",()=>{n.hidden=!0,s.hidden=!0})};function g(t=!1,a){const n=document.createElement("ul");return t===!0?n.classList.add("tag-tree","animate__animated"):n.classList.add("tag-tree","sub"),n.dataset.instanceId=`${a}`,n.tabIndex=0,n.role=t===!0?"tree":"group",n.ariaLabel="タグ選択ツリー",n}function u(t){t.addEventListener("dragstart",a=>{t.dataset.tagId!=="none"&&a.dataTransfer.setData("text/plain",a.target.id)}),t.addEventListener("dragover",a=>{a.preventDefault(),a.stopPropagation(),a.dataTransfer.dropEffect="move",t.style.borderTop="1px solid #cccccc",t.parentElement.style.backgroundColor="#2d2d2d"}),t.addEventListener("dragleave",a=>{a.preventDefault(),a.stopPropagation(),t.style.borderTop="unset",t.parentElement.style.backgroundColor="unset"}),t.addEventListener("drop",a=>{a.preventDefault(),a.stopPropagation(),t.style.borderTop="unset";const n=t.parentElement;n.style.backgroundColor="unset";let s="";if(a.dataTransfer.items)for(const r of a.dataTransfer.items){const{kind:m,type:i}=r;m==="file"||m==="string"&&i==="text/plain"&&(s=a.dataTransfer.getData(i))}if(s!==""){const m=e.liveDom.tagTreePanel[e.currentInstanceId].querySelector(`#${s}`),i=m.querySelector("button.tag-name");n.querySelector(`button[data-parent-tag-id="${m.dataset.parentTagId}"][data-tag-id="${m.dataset.tagId}"]`)===null&&t.dataset.tagId!=="none"&&window.electron.ipcRenderer.invoke("update-tag-structure",{instanceId:e.currentInstanceId,delete:{parentId:m.dataset.parentTagId,childId:m.dataset.tagId},set:{parentId:n.dataset.parentTagId,childId:m.dataset.tagId}}).then(w=>{w===!0&&(m.dataset.parentTagId=n.dataset.parentTagId,i.dataset.parentTagId=n.dataset.parentTagId)}),n.insertBefore(m,t),t.dataset.tagId==="none"&&t.remove()}})}function p(t,a){const n=document.createElement("li");n.role="treeitem",n.id=`item-tag-${t}`,n.dataset.tagId=`${t}`,n.draggable=!0,u(n);const s=document.createElement("span");s.classList.add("for-hover");const r=document.createElement("button"),m=document.createElement("button"),i=document.createElement("button");return r.classList.add("expansion"),r.innerHTML='<i class="fa-solid fa-chevron-down"></i>',r.dataset.opend="false",r.dataset.tagId=`${t}`,m.classList.add("tag-name"),m.textContent=a,m.dataset.tagId=`${t}`,i.classList.add("tag-menu-btn"),i.hidden=!0,i.dataset.tagId=`${t}`,i.innerHTML='<i class="fa-solid fa-ellipsis"></i>',i.ariaLabel="このタグのメニューを開く",s.append(r),s.append(m),s.append(i),n.append(s),[n,r,m,i]}const b=async(t,a,n)=>new Promise(async s=>{let r=null;for(;r===null;)t===null?r=await window.electron.ipcRenderer.invoke("get-tag-tree",a):r=await window.electron.ipcRenderer.invoke("get-sub-tags",{instanceId:a,parentId:n});const m=t===null,i=g(m,a),d=[],w=[],h=[];if(r.length!==0)r.forEach(L=>{const[I,S,q,B]=p(Number(L.id),L.name);S.dataset.loaded=t===null?"true":"false",f(m,n,I,q),d.push(S),w.push(q),h.push(B),i.append(I)});else{const L=document.createElement("li");L.role="treeitem",L.dataset.tagId="none";const I=document.createElement("button");I.style.paddingLeft="15px",I.dataset.tagId="none",I.textContent="登録無し",u(L),d.push(I),L.append(I),i.append(L)}i.dataset.parentTagId="0",m===!0&&(i.style.height="100%"),t===null?(e.currentInstanceId!==a?(i.classList.add("animate__fadeOutRight"),i.inert=!0):i.classList.add("animate__fadeInLeft"),o({expansionButtonList:d,tagNameButtonList:w,tagMenuButtonList:h},!0),e.liveDom.tagTreePanel[a]=i,e.liveDom.instancePanel.querySelector("div.tag-select-panel").insertAdjacentElement("beforeend",i)):(i.inert=!0,i.dataset.parentTagId=`${n}`,i.classList.add("sub"),t.insertAdjacentElement("beforeend",i),o({expansionButtonList:d,tagNameButtonList:w,tagMenuButtonList:h},!0)),s({expansionButtonList:d,tagNameButtonList:w,tagMenuButtonList:h})});function f(t,a,n,s){t===!1?(s.dataset.parentTagId=`${a}`,n.dataset.parentTagId=`${a}`):(s.dataset.parentTagId="0",n.dataset.parentTagId="0")}function c(t=!1){const a=document.createElement("li"),n=document.createElement("form"),s=document.createElement("input");return a.role="treeitem",t===!1?n.classList.add("insert-tag-form"):n.classList.add("update-tag-form"),n.addEventListener("submit",r=>{r.preventDefault()}),n.innerHTML='<i class="fa-solid fa-chevron-right"></i>',s.type="text",n.append(s),a.append(n),[a,n,s]}function v(t=null,a=null,n=!1,s){const[r,m,i]=c(n),d=t===null;if(t===null&&(t=e.liveDom.tagTreePanel[e.currentInstanceId]),i.addEventListener("keydown",async w=>{if(w.code==="Enter"&&w.isComposing===!1)if(n===!1){let h=!1;if([...t.querySelectorAll(`button.tag-name[data-parent-tag-id='${a===null?0:a}']`)].forEach(L=>{if(L.textContent===i.value){h=!0;return}}),h!==!1)return;window.electron.ipcRenderer.invoke("add-tag",{instanceId:e.currentInstanceId,name:i.value,parentTagId:a}).then(L=>{if(L!==null){const I=L.id!==void 0?L.id:L.lastInsertRowid,[S,q,B,C]=p(I,i.value);q.dataset.loaded="false",o({expansionButtonList:[q],tagNameButtonList:[B],tagMenuButtonList:[C]}),f(d,a,S,B),t?.insertAdjacentElement("beforeend",S),t.childElementCount<=3&&t.querySelector('li > button[data-tag-id="none"]')?.parentElement?.remove(),r.remove()}})}else window.electron.ipcRenderer.invoke("update-tag-name",{instanceId:e.currentInstanceId,name:i.value,tagId:a}).then(h=>{if(h!==null){const L=s?.querySelector("button.tag-name");L.textContent=i.value,[...e.liveDom.tagTreePanel[e.currentInstanceId].querySelectorAll(`button.tag-name[data-tag-id='${a}']`)].forEach(I=>{I.textContent=i.value}),m.remove()}})}),i.addEventListener("keyup",async w=>{if(w.isComposing===!1&&i.value!==""&&w.code!=="Backspace"&&w.code!=="ArrowLeft"&&w.code!=="ArrowRight"){const h=await window.electron.ipcRenderer.invoke("add-tag-suggest",{id:e.currentInstanceId,value:i.value});if(h!==void 0){const L=i.value.length;i.value=h.name,i.selectionStart=L,i.selectionEnd=h.name.length,i.focus()}}}),i.addEventListener("focusout",()=>{n===!1?r.remove():m.remove()}),n===!1)t.insertAdjacentElement("afterbegin",r);else{const w=s?.querySelector("button.tag-name")?.textContent;i.value=w,s?.append(m)}i.focus()}function k(){const t={};for(const[n,s]of Object.entries(e.liveDom.tagTreePanel))t[n]=s.outerHTML;let a=null;if(l)for(const[n,s]of Object.entries(l)){a===null&&(a={});const r=s.querySelector("button.tag-name");a[n]=Number(r.dataset.tagId)}console.log("add cache"),window.electron.ipcRenderer.invoke("set-tag-tree-cache",{tagTreeCache:t,selectedTags:a})}if(e.liveDom.instancePanel.querySelector("div.tag-select-panel").addEventListener("click",()=>{k()}),e.liveDom.instancePanel.querySelector("#add-new-tag").addEventListener("click",()=>{v()}),e.config.cache?.tagTreeDomStrings!==null){const t=[],a=[],n=[],s=e.liveDom.instancePanel.querySelector("div.tag-select-panel");for(const[r,m]of Object.entries(e.config.cache.tagTreeDomStrings)){s.insertAdjacentHTML("beforeend",m);const i=s.querySelector(`ul[role='tree'][data-instance-id='${r}']`);e.liveDom.tagTreePanel[Number(r)]=i,t.push(...i.querySelectorAll("button.expansion")),a.push(...i.querySelectorAll("button.tag-name")),n.push(...i.querySelectorAll("button.tag-menu-btn")),[...i.querySelectorAll("li[role='treeitem']")].forEach(d=>{u(d)})}e.config.cache&&e.config.cache.selectedTags&&Object.entries(e.config.cache.selectedTags).forEach(r=>{const m=e.liveDom.instancePanel.querySelector(`div.tag-select-panel button.tag-name[data-tag-id='${r[1]}']`);l||(l={}),m&&m.parentNode&&(l[Number(r[0])]=m.parentNode)}),o({expansionButtonList:t,tagNameButtonList:a,tagMenuButtonList:n})}else e.instanceDBs.forEach(t=>{b(null,t.id,0).then(a=>{a.expansionButtonList.forEach(n=>{b(n.parentNode?.parentNode,t.id,Number(n.dataset.tagId))})})});window.addEventListener("ite_change",async t=>{e.liveDom.tagTreePanel[t.detail.id]!==void 0&&(e.liveDom.tagTreePanel[t.detail.id].classList.replace("animate__fadeInLeft","animate__fadeOutRight"),e.liveDom.tagTreePanel[t.detail.id].inert=!0),e.liveDom.tagTreePanel[e.currentInstanceId]===void 0&&(await b(null,e.currentInstanceId,0).then(a=>{a.expansionButtonList.forEach(n=>{b(n.parentNode?.parentNode,e.currentInstanceId,Number(n.dataset.tagId))})}),e.liveDom.instancePanel.querySelector("div.tag-select-panel").dispatchEvent(new Event("click"))),e.liveDom.tagTreePanel[e.currentInstanceId].classList.replace("animate__fadeOutRight","animate__fadeInLeft"),e.liveDom.tagTreePanel[e.currentInstanceId].inert=!1},!1);const y=e.liveDom.instancePanel.querySelector("span.resize-panel-bar"),E=e.liveDom.instancePanel.querySelector("div.tag-select-panel"),T=t=>{E.style.flexBasis=`${t.x}px`};y.addEventListener("mousedown",()=>{document.addEventListener("mousemove",T,!1),document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",T,!1)},!1)})},addContents:function(){const l=e.liveDom.contentsPanel.base.querySelector("div.content-elements-wrap"),o=e.liveDom.contentsPanel.base.querySelector("div.page-details-wrap"),g=o.querySelector("div.content.browse > div.browse"),u=o.querySelector("#bk-dts-title");[...o.querySelectorAll("div.tab-bar > input.details-tab-radio")].forEach(p=>{p.addEventListener("click",b=>{const f=o.querySelector("div.tab-contents > div.content.animate__fadeIn");f.classList.replace("animate__fadeIn","animate__fadeOut"),f.inert=!0;const c=o.querySelector(`div.tab-contents > div.content.${b.target.value}`);c.classList.replace("animate__fadeOut","animate__fadeIn"),c.inert=!1,b.target.value==="browse"&&(g.dataset.isLoaded="true",g.childNodes[1].setAttribute("src",g.dataset.url))})}),e.liveDom.contentsPanel.base.querySelector("div.page-details-content > button.close").addEventListener("click",()=>{l.classList.remove("wh-50"),o.classList.remove("wh-50"),o.inert=!0}),u.addEventListener("input",p=>{P(p.target)},!1),e.liveDom.contentsPanel.base.querySelector("div.page-details-content span.tag_input_wrap").hidden=!0,e.shareParts.toggleLoadingEfect(!0),window.electron.ipcRenderer.invoke("get-bookmarks",{instanceId:e.currentInstanceId,tagIdChain:null}).then(e.shareParts.getBookmarkItemDom),e.liveDom.instancePanel.querySelector("div.contents-panel").appendChild(e.liveDom.contentsPanel.base)}},shareParts:{getBookmarkItemDom:function(l){const o=e.liveDom.contentsPanel.base.querySelector("div.content-elements-wrap"),g=e.liveDom.contentsPanel.base.querySelector("div#insert-ce"),u=e.liveDom.contentsPanel.base.querySelector("div.page-details-wrap"),p=e.liveDom.contentsPanel.base.querySelector("div.page-details-content"),f=p.querySelector("div.content.details").querySelector("div.preview"),c=u.querySelector("div.tab-contents > div.content.browse"),v=p.querySelector("div.content.browse > div.browse"),k=p.querySelector("#bk-dts-title"),y=p.querySelector("#bk-dts-url"),E=p.querySelector("#bk-dts-dsc"),T=p.querySelector("span.selected-label");g.innerHTML="",l.forEach(t=>{const a=D.contentsPanel.bookmarkItem(),n=a.querySelector("div.hover-for-mouse"),s=a.querySelector("div.thumbnail"),r=a.querySelector("span.link"),m=a.querySelector("p.description");if(a.querySelector("button.float.open-link").addEventListener("click",()=>{window.open(t.url,"_blank")}),a.querySelector("button.float.delete").addEventListener("click",()=>{confirm("このブックマークを削除してもよろしいですか？")&&window.electron.ipcRenderer.invoke("remove-bookmark",{instanceId:e.currentInstanceId,bookmarkId:t.id}).then(d=>{d&&(a.classList.replace("animate__fadeIn","animate__fadeOut"),setTimeout(()=>{a.remove()},500))})}),t.thunb){const d=document.createElement("img");d.src=window.URL.createObjectURL(new Blob([t.thunb],{type:t.thunb_mime})),d.alt="サムネイル画像",s.appendChild(d)}else{const d=document.createElement("span");d.classList.add("no-thumbnail"),d.textContent="No thumbnail",s.appendChild(d)}r.textContent=t.title;let i="";t.description&&t.description.length>85?i=t.description.substring(0,85)+"...":i=t.description,m.textContent=i,n.addEventListener("click",()=>{if(t.url.match(/^https:\/\/www\.youtube\.com\/watch\?v=/)){const w=new URL(t.url).searchParams,h=document.createElement("iframe");h.src=`https://www.youtube.com/embed/${w.get("v")}`,h.title=t.title,h.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",h.allowFullscreen=!0,h.frameBorder="0",h.style.width="100%",h.style.aspectRatio="16 / 9",f.innerHTML="",f.appendChild(h)}else{const d=document.createElement("img");d.style.width="100%",d.src=window.URL.createObjectURL(new Blob([t.thunb],{type:t.thunb_mime})),d.alt="サムネイル画像",f.innerHTML="",f.appendChild(d)}k.value=t.title,setTimeout(()=>{P(k)},300),y.value=t.url,E.value=t.description,setTimeout(()=>{P(E)},300),window.electron.ipcRenderer.invoke("get-tags-in-bookmark",{instanceId:e.currentInstanceId,bookmarkId:t.id}).then(d=>{d&&T.dispatchEvent(new CustomEvent("tag-insert",{detail:d}))}),v.dataset.url=t.url,v.dataset.isLoaded="false",c.inert||v.childNodes[1].setAttribute("src",t.url),o.classList.add("wh-50"),u.classList.add("wh-50"),u.inert=!1}),g.appendChild(a)}),e.shareParts.toggleLoadingEfect(!1)},toggleLoadingEfect:function(l){const o=e.liveDom.base.querySelector("main"),g=e.liveDom.base.querySelector("#show-loading-efect");l===!0?(o.inert=!0,g.inert=!1,g.classList.add("show")):(o.inert=!1,g.inert=!0,g.classList.remove("show"))}}};function P(l){l.style.height="0",l.style.height=l.scrollHeight+"px"}function R(l,o){switch(l){case"url":return!!o.match(/https?:\/[\w!?/+\-_~;.,*&@#$%()'[\]]+/);case"mail":return!!o.match(/[\w\-\._]+@[\w\-\._]+\.[A-Za-z]+/)}}window.app=e;window.addEventListener("DOMContentLoaded",()=>{e.init()});
